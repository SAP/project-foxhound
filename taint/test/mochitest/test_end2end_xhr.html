<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="utf-8">
    <title>End-to_End Tests</title>
    <script src="/tests/SimpleTest/SimpleTest.js"></script>
    <link rel="stylesheet" href="/tests/SimpleTest/test.css"/>
  </head>
  <body>
    <div id="tainted">foo</div>
  </body>
      <script>
        let responses = 0;
        let total_tests = 10;
      SimpleTest.waitForExplicitFinish();

      function runTest(method) {
        SimpleTest.info(`Test: ${method}`);
            let request = new XMLHttpRequest();
            request.onload = async () => {
                let resp = request.response;
                SimpleTest.info(`done! Response: ${resp}`);
                check_tainted(resp);
                responses++;
                if(responses == total_tests) {
                  SimpleTest.finish();
                }

            };
            //request.open("GET", "http://mochi.test:8888/tests/SimpleTest/setup.js", true);
            request.open("GET", `http://mochi.test:8888/tests/taint/test/mochitest/xhr_server.sjs?${method}`, true);
            //request.open("GET", "/tests/SimpleTest/test.css", true);
            request.send("");

        }

        function runTestHTML(method) {
            SimpleTest.info(`Test: ${method}`);
            let request = new XMLHttpRequest();
            request.responseType = "document";
            request.onload = async () => {
                let resp = request.responseXML;
                let a = resp.getElementById("a");
                SimpleTest.info(`done for HTML: ${method}! Response: ${a.innerHTML}`);
                check_tainted(a.innerHTML);
                responses++;
                if(responses == total_tests) {
                  SimpleTest.finish();
                }

            };
            //request.open("GET", "http://mochi.test:8888/tests/SimpleTest/setup.js", true);
            request.open("GET", `http://mochi.test:8888/tests/taint/test/mochitest/xhr_server.sjs?${method}`, true);
            //request.open("GET", "/tests/SimpleTest/test.css", true);
            request.send("");

        }

        function runTestXML(method) {
            SimpleTest.info(`Test: ${method}`);
            let request = new XMLHttpRequest();
            request.onload = async () => {
                let resp = request.responseXML;
                let a = resp.getElementById("a");
                SimpleTest.info(`done for XML: ${method}! Response: ${a.innerHTML}`);
                check_tainted(a.innerHTML);
                responses++;
                if(responses == total_tests) {
                  SimpleTest.finish();
                }

            };
            //request.open("GET", "http://mochi.test:8888/tests/SimpleTest/setup.js", true);
            request.open("GET", `http://mochi.test:8888/tests/taint/test/mochitest/xhr_server.sjs?${method}`, true);
            //request.open("GET", "/tests/SimpleTest/test.css", true);
            request.send("");

        }

        function runTestSync(method) {
          SimpleTest.info(`Test: ${method}`);
            let request = new XMLHttpRequest();
            //request.open("GET", "http://mochi.test:8888/tests/SimpleTest/setup.js", true);
            request.open("GET", `http://mochi.test:8888/tests/taint/test/mochitest/xhr_server.sjs?${method}`, false);
            //request.open("GET", "/tests/SimpleTest/test.css", true);
            request.send("");
            let resp = request.response;
                SimpleTest.info(`done for ${method}! Response: ${resp}`);
                check_tainted(resp);
                responses++;
                if(responses == total_tests) {
                  SimpleTest.finish();
                }

        }

         runTest("e2e");
         runTest("e2e-partial");
         runTest("e2e-partial-html");
         runTest("e2e-html");
         // The XML tests currently fail due to usage of an external XML Parser
         // See e.g. nsParser.cpp and nsExpatDriver.cpp
         // runTestXML("e2e-xml");
         // runTestXML("e2e-partial-xml");
         runTestSync("e2e");
         runTest("e2e-partial");
         runTestSync("e2e-partial-html");
         runTestSync("e2e-html");
         runTestHTML("e2e-html");
         runTestHTML("e2e-partial-html");

    </script>
</html>